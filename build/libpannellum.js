window.libpannellum=function(a,b){'use strict';function c(c){function k(c,a){return 1==c.level&&1!=a.level?-1:1==a.level&&1!=c.level?1:a.timestamp-c.timestamp}function l(c,a){return c.level==a.level?c.diff-a.diff:c.level-a.level}function m(){if(!O.drawInProgress){O.drawInProgress=!0,P.clear(P.COLOR_BUFFER_BIT);for(var a=0;a<O.currentNodes.length;a++)1<O.currentNodes[a].textureLoaded&&(P.bindBuffer(P.ARRAY_BUFFER,$),P.bufferData(P.ARRAY_BUFFER,new Float32Array(O.currentNodes[a].vertices),P.STATIC_DRAW),P.vertexAttribPointer(O.vertPosLocation,3,P.FLOAT,!1,0,0),P.bindBuffer(P.ARRAY_BUFFER,_),P.vertexAttribPointer(O.texCoordLocation,2,P.FLOAT,!1,0,0),P.bindTexture(P.TEXTURE_2D,O.currentNodes[a].texture),P.drawElements(P.TRIANGLES,6,P.UNSIGNED_SHORT,0));O.drawInProgress=!1}}function n(a,b,c,d,e,f){this.vertices=a,this.side=b,this.level=c,this.x=d,this.y=e,this.path=f.replace('%s',b).replace('%l',c).replace('%x',d).replace('%y',e)}function i(a,b,c,d,e){if(A(a,b.vertices)){var g=b.vertices,h=g[0]+g[3]+g[6]+g[9],l=g[1]+g[4]+g[7]+g[10],m=g[2]+g[5]+g[8]+g[11],o=G(h*h+l*l+m*m),p=I(m/o),q=H(l,h),r=q-d;r+=r>L?-2*L:r<-L?2*L:0,r=Math.abs(r),b.diff=F(J(c)*J(p)+K(c)*K(p)*K(r));for(var s=!1,t=0;t<O.nodeCache.length;t++)if(O.nodeCache[t].path==b.path){s=!0,O.nodeCache[t].timestamp=O.nodeCacheTimestamp++,O.nodeCache[t].diff=b.diff,O.currentNodes.push(O.nodeCache[t]);break}if(s||(b.timestamp=O.nodeCacheTimestamp++,O.currentNodes.push(b),O.nodeCache.push(b)),b.level<O.level){var u=W.cubeResolution*C(2,b.level-W.maxLevel),v=Math.ceil(u*W.invTileResolution)-1,w=2*(u%W.tileResolution),x=2*u%W.tileResolution;0===x&&(x=W.tileResolution),0==w&&(w=2*W.tileResolution);var y=.5;(b.x==v||b.y==v)&&(y=1-W.tileResolution/(W.tileResolution+x));var z,B,D=1-y,E=[],M=y,N=y,P=y,Q=D,R=D,S=D;x<W.tileResolution&&(b.x==v&&b.y!=v?(N=.5,R=.5,('d'==b.side||'u'==b.side)&&(P=.5,S=.5)):b.x!=v&&b.y==v&&(M=.5,Q=.5,('l'==b.side||'r'==b.side)&&(P=.5,S=.5))),w<=W.tileResolution&&(b.x==v&&(M=0,Q=1,('l'==b.side||'r'==b.side)&&(P=0,S=1)),b.y==v&&(N=0,R=1,('d'==b.side||'u'==b.side)&&(P=0,S=1))),z=[g[0],g[1],g[2],g[0]*M+g[3]*Q,g[1]*y+g[4]*D,g[2]*P+g[5]*S,g[0]*M+g[6]*Q,g[1]*N+g[7]*R,g[2]*P+g[8]*S,g[0]*y+g[9]*D,g[1]*N+g[10]*R,g[2]*P+g[11]*S],B=new n(z,b.side,b.level+1,2*b.x,2*b.y,W.fullpath),E.push(B),b.x==v&&w<=W.tileResolution||(z=[g[0]*M+g[3]*Q,g[1]*y+g[4]*D,g[2]*P+g[5]*S,g[3],g[4],g[5],g[3]*y+g[6]*D,g[4]*N+g[7]*R,g[5]*P+g[8]*S,g[0]*M+g[6]*Q,g[1]*N+g[7]*R,g[2]*P+g[8]*S],B=new n(z,b.side,b.level+1,2*b.x+1,2*b.y,W.fullpath),E.push(B)),b.x==v&&w<=W.tileResolution||b.y==v&&w<=W.tileResolution||(z=[g[0]*M+g[6]*Q,g[1]*N+g[7]*R,g[2]*P+g[8]*S,g[3]*y+g[6]*D,g[4]*N+g[7]*R,g[5]*P+g[8]*S,g[6],g[7],g[8],g[9]*M+g[6]*Q,g[10]*y+g[7]*D,g[11]*P+g[8]*S],B=new n(z,b.side,b.level+1,2*b.x+1,2*b.y+1,W.fullpath),E.push(B)),b.y==v&&w<=W.tileResolution||(z=[g[0]*y+g[9]*D,g[1]*N+g[10]*R,g[2]*P+g[11]*S,g[0]*M+g[6]*Q,g[1]*N+g[7]*R,g[2]*P+g[8]*S,g[9]*M+g[6]*Q,g[10]*y+g[7]*D,g[11]*P+g[8]*S,g[9],g[10],g[11]],B=new n(z,b.side,b.level+1,2*b.x,2*b.y+1,W.fullpath),E.push(B));for(var T=0;T<E.length;T++)i(a,E[T],c,d,e)}}}function o(){return[-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1]}function p(){return[1,0,0,0,1,0,0,0,1]}function q(a,b,d){var e=J(b),f=K(b);return'x'==d?[a[0],f*a[1]+e*a[2],f*a[2]-e*a[1],a[3],f*a[4]+e*a[5],f*a[5]-e*a[4],a[6],f*a[7]+e*a[8],f*a[8]-e*a[7]]:'y'==d?[f*a[0]-e*a[2],a[1],f*a[2]+e*a[0],f*a[3]-e*a[5],a[4],f*a[5]+e*a[3],f*a[6]-e*a[8],a[7],f*a[8]+e*a[6]]:'z'==d?[f*a[0]+e*a[1],f*a[1]-e*a[0],a[2],f*a[3]+e*a[4],f*a[4]-e*a[3],a[5],f*a[6]+e*a[7],f*a[7]-e*a[6],a[8]]:void 0}function r(a){return[a[0],a[1],a[2],0,a[3],a[4],a[5],0,a[6],a[7],a[8],0,0,0,0,1]}function t(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]}function u(a,b,c,d){var e=2*D(E(a/2)*P.drawingBufferHeight/P.drawingBufferWidth),g=1/E(e/2);return[g/b,0,0,0,0,g,0,0,0,0,(d+c)/(c-d),2*d*c/(c-d),0,0,-1,0]}function s(a,b){P.bindTexture(P.TEXTURE_2D,b),P.texImage2D(P.TEXTURE_2D,0,P.RGB,P.RGB,P.UNSIGNED_BYTE,a),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MAG_FILTER,P.LINEAR),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MIN_FILTER,P.LINEAR),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_WRAP_S,P.CLAMP_TO_EDGE),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_WRAP_T,P.CLAMP_TO_EDGE),P.bindTexture(P.TEXTURE_2D,null)}function v(a){da(a,a.path+'.'+W.extension,function(b,c){a.texture=b,a.textureLoaded=c?2:1},ba.crossOrigin)}function w(a){for(var b=1;b<W.maxLevel&&P.drawingBufferWidth>.707*(W.tileResolution*C(2,b-1)*E(a/2));)b++;O.level=b}function x(a,b){return[a[0]*b[0],a[0]*b[1],a[0]*b[2],0,a[5]*b[4],a[5]*b[5],a[5]*b[6],0,a[10]*b[8],a[10]*b[9],a[10]*b[10],a[11],-b[8],-b[9],-b[10],0]}function y(a,b){return[a[0]*b[0]+a[1]*b[1]+a[2]*b[2],a[4]*b[0]+a[5]*b[1]+a[6]*b[2],a[11]+a[8]*b[0]+a[9]*b[1]+a[10]*b[2],1/(a[12]*b[0]+a[13]*b[1]+a[14]*b[2])]}function z(a,b){var c=y(a,b),d=c[0]*c[3],e=c[1]*c[3],f=c[2]*c[3],g=[0,0,0];return-1>d&&(g[0]=-1),1<d&&(g[0]=1),-1>e&&(g[1]=-1),1<e&&(g[1]=1),(-1>f||1<f)&&(g[2]=1),g}function A(a,b){var c=z(a,b.slice(0,3)),d=z(a,b.slice(3,6)),e=z(a,b.slice(6,9)),f=z(a,b.slice(9,12)),g=c[0]+d[0]+e[0]+f[0];if(-4==g||4==g)return!1;var h=c[1]+d[1]+e[1]+f[1];if(-4==h||4==h)return!1;var i=c[2]+d[2]+e[2]+f[2];return 4!=i}function B(){var a=Math.round;console.log('Reducing canvas size due to error 1286!'),N.width=a(N.width/2),N.height=a(N.height/2)}var C=Math.pow,D=Math.atan,E=Math.tan,F=Math.acos,G=Math.sqrt,H=Math.atan2,I=Math.asin,J=Math.sin,K=Math.cos,L=Math.PI,M=Math.max,N=b.createElement('canvas');N.style.width=N.style.height='100%',c.appendChild(N);var O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba;this.init=function(a,k,l,m,n,p,q,r){function t(a){if(x){var b=4*(a*a),c=new Uint8ClampedArray(b),d=r.backgroundColor?r.backgroundColor:[0,0,0];d[0]*=255,d[1]*=255,d[2]*=255;for(var e=0;e<b;e++)c[e++]=d[0],c[e++]=d[1],c[e++]=d[2];var f=new ImageData(c,a,a);for(v=0;6>v;v++)0==W[v].width&&(W[v]=f)}}if(void 0===k&&(k='equirectangular'),'equirectangular'!=k&&'cubemap'!=k&&'multires'!=k)throw console.log('Error: invalid image type specified!'),{type:'config error'};if(X=k,W=a,Y=l,ba=r||{},O){if(Q&&(P.detachShader(O,Q),P.deleteShader(Q)),R&&(P.detachShader(O,R),P.deleteShader(R)),P.bindBuffer(P.ARRAY_BUFFER,null),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),O.texture&&P.deleteTexture(O.texture),O.nodeCache)for(var u=0;u<O.nodeCache.length;u++)P.deleteTexture(O.nodeCache[u].texture);P.deleteProgram(O),O=void 0}V=void 0;var v,w,x=!1;if('cubemap'==X)for(v=0;6>v;v++)0<W[v].width?(void 0===w&&(w=W[v].width),w!=W[v].width&&console.log('Cube faces have inconsistent widths: '+w+' vs. '+W[v].width)):x=!0;if('cubemap'==X&&0!=(w&w-1)&&(navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 8_/)||navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 9_/)||navigator.userAgent.toLowerCase().match(/(iphone|ipod|ipad).* os 10_/)||navigator.userAgent.match(/Trident.*rv[ :]*11\./))||(!P&&(P=N.getContext('experimental-webgl',{alpha:!1,depth:!1})),P&&1286==P.getError()&&B()),!P&&('multires'==X&&W.hasOwnProperty('fallbackPath')||'cubemap'==X)&&('WebkitAppearance'in b.documentElement.style||navigator.userAgent.match(/Trident.*rv[ :]*11\./)||-1!==navigator.appVersion.indexOf('MSIE 10'))){T&&c.removeChild(T),T=b.createElement('div'),T.className='pnlm-world';var y=W.basePath?W.basePath+W.fallbackPath:W.fallbackPath;var z=['f','r','b','l','u','d'],A=0,C=function(){var a=b.createElement('canvas');a.className='pnlm-face pnlm-'+z[this.side]+'face',T.appendChild(a);var c=a.getContext('2d');a.style.width=this.width+4+'px',a.style.height=this.height+4+'px',a.width=this.width+4,a.height=this.height+4,c.drawImage(this,2,2);var d,e,f=c.getImageData(0,0,a.width,a.height),g=f.data;for(d=2;d<a.width-2;d++)for(e=0;4>e;e++)g[4*(d+a.width)+e]=g[4*(d+2*a.width)+e],g[4*(d+a.width*(a.height-2))+e]=g[4*(d+a.width*(a.height-3))+e];for(d=2;d<a.height-2;d++)for(e=0;4>e;e++)g[4*(d*a.width+1)+e]=g[4*(d*a.width+2)+e],g[4*((d+1)*a.width-2)+e]=g[4*((d+1)*a.width-3)+e];for(e=0;4>e;e++)g[4*(a.width+1)+e]=g[4*(2*a.width+2)+e],g[4*(2*a.width-2)+e]=g[4*(3*a.width-3)+e],g[4*(a.width*(a.height-2)+1)+e]=g[4*(a.width*(a.height-3)+2)+e],g[4*(a.width*(a.height-1)-2)+e]=g[4*(a.width*(a.height-2)-3)+e];for(d=1;d<a.width-1;d++)for(e=0;4>e;e++)g[4*d+e]=g[4*(d+a.width)+e],g[4*(d+a.width*(a.height-1))+e]=g[4*(d+a.width*(a.height-2))+e];for(d=1;d<a.height-1;d++)for(e=0;4>e;e++)g[4*(d*a.width)+e]=g[4*(d*a.width+1)+e],g[4*((d+1)*a.width-1)+e]=g[4*((d+1)*a.width-2)+e];for(e=0;4>e;e++)g[e]=g[4*(a.width+1)+e],g[4*(a.width-1)+e]=g[4*(2*a.width-2)+e],g[4*(a.width*(a.height-1))+e]=g[4*(a.width*(a.height-2)+1)+e],g[4*(a.width*a.height-1)+e]=g[4*(a.width*(a.height-1)-2)+e];c.putImageData(f,0,0),D.call(this)},D=function(){0<this.width?(void 0===S&&(S=this.width),S!=this.width&&console.log('Fallback faces have inconsistent widths: '+S+' vs. '+this.width)):x=!0,A++,6==A&&(S=this.width,c.appendChild(T),q())};for(x=!1,v=0;6>v;v++){var E=new Image;E.crossOrigin=ba.crossOrigin?ba.crossOrigin:'anonymous',E.side=v,E.onload=C,E.onerror=D,E.src='multires'==X?y.replace('%s',z[v])+'.'+W.extension:W[v].src}return void t(S)}if(!P)throw console.log('Error: no WebGL support detected!'),{type:'no webgl'};'cubemap'==X&&t(w),W.fullpath=W.basePath?W.basePath+W.path:W.path,W.invTileResolution=1/W.tileResolution;var F=o();for(U=[],v=0;6>v;v++)U[v]=F.slice(12*v,12*v+12),F=o();var G=0;if('equirectangular'==X){if(G=P.getParameter(P.MAX_TEXTURE_SIZE),M(W.width/2,W.height)>G)throw console.log('Error: The image is too big; it\'s '+W.width+'px wide, but this device\'s maximum supported size is '+2*G+'px.'),{type:'webgl size error',width:W.width,maxWidth:2*G};}else if('cubemap'==X&&w>P.getParameter(P.MAX_CUBE_MAP_TEXTURE_SIZE))throw console.log('Error: The image is too big; it\'s '+w+'px wide, but this device\'s maximum supported size is '+G+'px.'),{type:'webgl size error',width:w,maxWidth:G};if(void 0!==r){var H=isNaN(r.horizonPitch)?0:+r.horizonPitch,I=isNaN(r.horizonRoll)?0:+r.horizonRoll;(0!=H||0!=I)&&(V=[H,I])}var J=P.TEXTURE_2D;if(P.viewport(0,0,P.drawingBufferWidth,P.drawingBufferHeight),P.getShaderPrecisionFormat){var K=P.getShaderPrecisionFormat(P.FRAGMENT_SHADER,P.HIGH_FLOAT);K&&1>K.precision&&(f=f.replace('highp','mediump'))}Q=P.createShader(P.VERTEX_SHADER);var ca=d;'multires'==X&&(ca=e),P.shaderSource(Q,ca),P.compileShader(Q),R=P.createShader(P.FRAGMENT_SHADER);var da=h;'cubemap'==X?(J=P.TEXTURE_CUBE_MAP,da=g):'multires'==X&&(da=j),P.shaderSource(R,da),P.compileShader(R),O=P.createProgram(),P.attachShader(O,Q),P.attachShader(O,R),P.linkProgram(O),P.getShaderParameter(Q,P.COMPILE_STATUS)||console.log(P.getShaderInfoLog(Q)),P.getShaderParameter(R,P.COMPILE_STATUS)||console.log(P.getShaderInfoLog(R)),P.getProgramParameter(O,P.LINK_STATUS)||console.log(P.getProgramInfoLog(O)),P.useProgram(O),O.drawInProgress=!1;var ea=r.backgroundColor?r.backgroundColor:[0,0,0];if(P.clearColor(ea[0],ea[1],ea[2],1),P.clear(P.COLOR_BUFFER_BIT),O.texCoordLocation=P.getAttribLocation(O,'a_texCoord'),P.enableVertexAttribArray(O.texCoordLocation),'multires'!=X){if(Z||(Z=P.createBuffer()),P.bindBuffer(P.ARRAY_BUFFER,Z),P.bufferData(P.ARRAY_BUFFER,new Float32Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),P.STATIC_DRAW),P.vertexAttribPointer(O.texCoordLocation,2,P.FLOAT,!1,0,0),O.aspectRatio=P.getUniformLocation(O,'u_aspectRatio'),P.uniform1f(O.aspectRatio,P.drawingBufferWidth/P.drawingBufferHeight),O.psi=P.getUniformLocation(O,'u_psi'),O.theta=P.getUniformLocation(O,'u_theta'),O.f=P.getUniformLocation(O,'u_f'),O.h=P.getUniformLocation(O,'u_h'),O.v=P.getUniformLocation(O,'u_v'),O.vo=P.getUniformLocation(O,'u_vo'),O.rot=P.getUniformLocation(O,'u_rot'),P.uniform1f(O.h,m/(2*L)),P.uniform1f(O.v,n/L),P.uniform1f(O.vo,2*(p/L)),'equirectangular'==X&&(O.backgroundColor=P.getUniformLocation(O,'u_backgroundColor'),P.uniform4fv(O.backgroundColor,ea.concat([1]))),O.texture=P.createTexture(),P.bindTexture(J,O.texture),'cubemap'==X)P.texImage2D(P.TEXTURE_CUBE_MAP_POSITIVE_X,0,P.RGB,P.RGB,P.UNSIGNED_BYTE,W[1]),P.texImage2D(P.TEXTURE_CUBE_MAP_NEGATIVE_X,0,P.RGB,P.RGB,P.UNSIGNED_BYTE,W[3]),P.texImage2D(P.TEXTURE_CUBE_MAP_POSITIVE_Y,0,P.RGB,P.RGB,P.UNSIGNED_BYTE,W[4]),P.texImage2D(P.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,P.RGB,P.RGB,P.UNSIGNED_BYTE,W[5]),P.texImage2D(P.TEXTURE_CUBE_MAP_POSITIVE_Z,0,P.RGB,P.RGB,P.UNSIGNED_BYTE,W[0]),P.texImage2D(P.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,P.RGB,P.RGB,P.UNSIGNED_BYTE,W[2]);else if(W.width<=G)P.uniform1i(P.getUniformLocation(O,'u_splitImage'),0),P.texImage2D(J,0,P.RGB,P.RGB,P.UNSIGNED_BYTE,W);else{P.uniform1i(P.getUniformLocation(O,'u_splitImage'),1);var fa=b.createElement('canvas');fa.width=W.width/2,fa.height=W.height;var ga=fa.getContext('2d');ga.drawImage(W,0,0);var ha=ga.getImageData(0,0,W.width/2,W.height);P.texImage2D(J,0,P.RGB,P.RGB,P.UNSIGNED_BYTE,ha),O.texture2=P.createTexture(),P.activeTexture(P.TEXTURE1),P.bindTexture(J,O.texture2),P.uniform1i(P.getUniformLocation(O,'u_image1'),1),ga.drawImage(W,-W.width/2,0),ha=ga.getImageData(0,0,W.width/2,W.height),P.texImage2D(J,0,P.RGB,P.RGB,P.UNSIGNED_BYTE,ha),P.texParameteri(J,P.TEXTURE_WRAP_S,P.CLAMP_TO_EDGE),P.texParameteri(J,P.TEXTURE_WRAP_T,P.CLAMP_TO_EDGE),P.texParameteri(J,P.TEXTURE_MIN_FILTER,P.LINEAR),P.texParameteri(J,P.TEXTURE_MAG_FILTER,P.LINEAR),P.activeTexture(P.TEXTURE0)}P.texParameteri(J,P.TEXTURE_WRAP_S,P.CLAMP_TO_EDGE),P.texParameteri(J,P.TEXTURE_WRAP_T,P.CLAMP_TO_EDGE),P.texParameteri(J,P.TEXTURE_MIN_FILTER,P.LINEAR),P.texParameteri(J,P.TEXTURE_MAG_FILTER,P.LINEAR)}else O.vertPosLocation=P.getAttribLocation(O,'a_vertCoord'),P.enableVertexAttribArray(O.vertPosLocation),$||($=P.createBuffer()),_||(_=P.createBuffer()),aa||(aa=P.createBuffer()),P.bindBuffer(P.ARRAY_BUFFER,_),P.bufferData(P.ARRAY_BUFFER,new Float32Array([0,0,1,0,1,1,0,1]),P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,aa),P.bufferData(P.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),P.STATIC_DRAW),O.perspUniform=P.getUniformLocation(O,'u_perspMatrix'),O.cubeUniform=P.getUniformLocation(O,'u_cubeMatrix'),O.level=-1,O.currentNodes=[],O.nodeCache=[],O.nodeCacheTimestamp=0;var ia=P.getError();if(0!==ia)throw console.log('Error: Something went wrong with WebGL!',ia),{type:'webgl error'};q()},this.destroy=function(){if(void 0!==c&&(void 0!==N&&c.contains(N)&&c.removeChild(N),void 0!==T&&c.contains(T)&&c.removeChild(T)),P){var a=P.getExtension('WEBGL_lose_context');a&&a.loseContext()}},this.resize=function(){var b=a.devicePixelRatio||1;N.width=N.clientWidth*b,N.height=N.clientHeight*b,P&&(1286==P.getError()&&B(),P.viewport(0,0,P.drawingBufferWidth,P.drawingBufferHeight),'multires'!=X&&P.uniform1f(O.aspectRatio,N.clientWidth/N.clientHeight))},this.resize(),this.setPose=function(a,b){a=isNaN(a)?0:+a,b=isNaN(b)?0:+b,V=0==a&&0==b?void 0:[a,b]},this.render=function(a,b,c,d){var e,f,g,h=Math.min,o=0;if(void 0===d&&(d={}),d.roll&&(o=d.roll),void 0!==V){var A=V[0],B=V[1],C=a,Q=b,R=K(B)*J(a)*J(A)+K(a)*(K(A)*K(b)+J(B)*J(A)*J(b)),Z=-J(a)*J(B)+K(a)*K(B)*J(b),y=K(B)*K(A)*J(a)+K(a)*(-K(b)*J(A)+K(A)*J(B)*J(b));a=I(M(h(y,1),-1)),b=H(Z,R);var z=[K(C)*(J(B)*J(A)*K(Q)-K(A)*J(Q)),K(C)*K(B)*K(Q),K(C)*(K(A)*J(B)*K(Q)+J(Q)*J(A))],$=[-K(a)*J(b),K(a)*K(b)],_=F(M(h((z[0]*$[0]+z[1]*$[1])/(G(z[0]*z[0]+z[1]*z[1]+z[2]*z[2])*G($[0]*$[0]+$[1]*$[1])),1),-1));0>z[2]&&(_=2*L-_),o+=_}if(!P&&('multires'==X||'cubemap'==X)){g=S/2;var aa={f:'translate3d(-'+(g+2)+'px, -'+(g+2)+'px, -'+g+'px)',b:'translate3d('+(g+2)+'px, -'+(g+2)+'px, '+g+'px) rotateX(180deg) rotateZ(180deg)',u:'translate3d(-'+(g+2)+'px, -'+g+'px, '+(g+2)+'px) rotateX(270deg)',d:'translate3d(-'+(g+2)+'px, '+g+'px, -'+(g+2)+'px) rotateX(90deg)',l:'translate3d(-'+g+'px, -'+(g+2)+'px, '+(g+2)+'px) rotateX(180deg) rotateY(90deg) rotateZ(180deg)',r:'translate3d('+g+'px, -'+(g+2)+'px, -'+(g+2)+'px) rotateY(270deg)'};e=1/E(c/2);var ba=e*N.clientWidth/2+'px',da='perspective('+ba+') translateZ('+ba+') rotateX('+a+'rad) rotateY('+b+'rad) ',ea=Object.keys(aa);for(f=0;6>f;f++){var fa=T.querySelector('.pnlm-'+ea[f]+'face');fa&&(fa.style.webkitTransform=da+aa[ea[f]],fa.style.transform=da+aa[ea[f]])}return}if('multires'!=X){var ga=2*D(E(.5*c)/(P.drawingBufferWidth/P.drawingBufferHeight));e=1/E(.5*ga),P.uniform1f(O.psi,b),P.uniform1f(O.theta,a),P.uniform1f(O.rot,o),P.uniform1f(O.f,e),!0===Y&&'equirectangular'==X&&(P.bindTexture(P.TEXTURE_2D,O.texture),P.texImage2D(P.TEXTURE_2D,0,P.RGB,P.RGB,P.UNSIGNED_BYTE,W)),P.drawArrays(P.TRIANGLES,0,6)}else{var ha=u(c,P.drawingBufferWidth/P.drawingBufferHeight,.1,100);w(c);var ia=p();ia=q(ia,-o,'z'),ia=q(ia,-a,'x'),ia=q(ia,b,'y'),ia=r(ia),P.uniformMatrix4fv(O.perspUniform,!1,new Float32Array(t(ha))),P.uniformMatrix4fv(O.cubeUniform,!1,new Float32Array(t(ia)));var ja=x(ha,ia);if(O.nodeCache.sort(k),200<O.nodeCache.length&&O.nodeCache.length>O.currentNodes.length+50)for(var ka=O.nodeCache.splice(200,O.nodeCache.length-200),la=0;la<ka.length;la++)P.deleteTexture(ka[la].texture);O.currentNodes=[];var ma=['f','b','u','d','l','r'];for(g=0;6>g;g++){var na=new n(U[g],ma[g],1,0,0,W.fullpath);i(ja,na,a,b,c)}for(O.currentNodes.sort(l),f=ca.length-1;0<=f;f--)-1===O.currentNodes.indexOf(ca[f].node)&&(ca[f].node.textureLoad=!1,ca.splice(f,1));if(0===ca.length)for(f=0;f<O.currentNodes.length;f++){var oa=O.currentNodes[f];if(!oa.texture&&!oa.textureLoad){oa.textureLoad=!0,setTimeout(v,0,oa);break}}m()}return void 0===d.returnImage?void 0:N.toDataURL('image/png')},this.isLoading=function(){if(P&&'multires'==X)for(var a=0;a<O.currentNodes.length;a++)if(!O.currentNodes[a].textureLoaded)return!0;return!1},this.getCanvas=function(){return N};var ca=[],da=function(){function a(){var a=this;this.texture=this.callback=null,this.image=new Image,this.image.crossOrigin=d?d:'anonymous';var b=function(){0<a.image.width&&0<a.image.height?(s(a.image,a.texture),a.callback(a.texture,!0)):a.callback(a.texture,!1),c(a)};this.image.addEventListener('load',b),this.image.addEventListener('error',b)}function b(a,b,c,d){this.node=a,this.src=b,this.texture=c,this.callback=d}function c(a){if(ca.length){var b=ca.shift();a.loadTexture(b.src,b.texture,b.callback)}else f[e++]=a}var d,e=4,f={};a.prototype.loadTexture=function(a,b,c){this.texture=b,this.callback=c,this.image.src=a};for(var g=0;g<e;g++)f[g]=new a;return function(a,c,g,h){d=h;var i=P.createTexture();return e?f[--e].loadTexture(c,i,g):ca.push(new b(a,c,i,g)),i}}()}var d='attribute vec2 a_texCoord;varying vec2 v_texCoord;void main() {gl_Position = vec4(a_texCoord, 0.0, 1.0);v_texCoord = a_texCoord;}',e='attribute vec3 a_vertCoord;attribute vec2 a_texCoord;uniform mat4 u_cubeMatrix;uniform mat4 u_perspMatrix;varying mediump vec2 v_texCoord;void main(void) {gl_Position = u_perspMatrix * u_cubeMatrix * vec4(a_vertCoord, 1.0);v_texCoord = a_texCoord;}',f='precision highp float;\nuniform float u_aspectRatio;\nuniform float u_psi;\nuniform float u_theta;\nuniform float u_f;\nuniform float u_h;\nuniform float u_v;\nuniform float u_vo;\nuniform float u_rot;\nconst float PI = 3.14159265358979323846264;\nuniform sampler2D u_image0;\nuniform sampler2D u_image1;\nuniform bool u_splitImage;\nuniform samplerCube u_imageCube;\nvarying vec2 v_texCoord;\nuniform vec4 u_backgroundColor;\nvoid main() {\nfloat x = v_texCoord.x * u_aspectRatio;\nfloat y = v_texCoord.y;\nfloat sinrot = sin(u_rot);\nfloat cosrot = cos(u_rot);\nfloat rot_x = x * cosrot - y * sinrot;\nfloat rot_y = x * sinrot + y * cosrot;\nfloat sintheta = sin(u_theta);\nfloat costheta = cos(u_theta);\nfloat a = u_f * costheta - rot_y * sintheta;\nfloat root = sqrt(rot_x * rot_x + a * a);\nfloat lambda = atan(rot_x / root, a / root) + u_psi;\nfloat phi = atan((rot_y * costheta + u_f * sintheta) / root);',g=f+'float cosphi = cos(phi);\ngl_FragColor = textureCube(u_imageCube, vec3(cosphi*sin(lambda), sin(phi), cosphi*cos(lambda)));\n}',h=f+'lambda = mod(lambda + PI, PI * 2.0) - PI;\nvec2 coord = vec2(lambda / PI, phi / (PI / 2.0));\nif(coord.x < -u_h || coord.x > u_h || coord.y < -u_v + u_vo || coord.y > u_v + u_vo)\ngl_FragColor = u_backgroundColor;\nelse {\nif(u_splitImage) {\nif(coord.x < 0.0)\ngl_FragColor = texture2D(u_image0, vec2((coord.x + u_h) / u_h, (-coord.y + u_v + u_vo) / (u_v * 2.0)));\nelse\ngl_FragColor = texture2D(u_image1, vec2((coord.x + u_h) / u_h - 1.0, (-coord.y + u_v + u_vo) / (u_v * 2.0)));\n} else {\ngl_FragColor = texture2D(u_image0, vec2((coord.x + u_h) / (u_h * 2.0), (-coord.y + u_v + u_vo) / (u_v * 2.0)));\n}\n}\n}',j='varying mediump vec2 v_texCoord;uniform sampler2D u_sampler;void main(void) {gl_FragColor = texture2D(u_sampler, v_texCoord);}';return{renderer:function(a,b,d,e){return new c(a,b,d,e)}}}(window,document);